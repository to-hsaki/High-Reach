<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>High-Reach AI Pro (Rear Cam)</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils"></script>
    <style>
        body { margin: 0; background: #121212; color: white; font-family: sans-serif; overflow: hidden; display: flex; flex-direction: column; align-items: center; }
        .header { background: rgba(0,0,0,0.9); width: 100%; padding: 10px; text-align: center; border-bottom: 2px solid #00ffcc; position: fixed; top: 0; z-index: 100; }
        #status-msg { color: #ffcc00; font-size: 0.9rem; margin-bottom: 5px; }
        .stats { display: flex; justify-content: center; gap: 30px; }
        .value { color: #00ffcc; font-size: 1.8rem; font-weight: bold; }
        canvas { width: 100vw; height: 100vh; object-fit: contain; background: #000; }
        .controls { position: fixed; bottom: 20px; display: flex; gap: 10px; z-index: 100; }
        button { padding: 12px 20px; border-radius: 25px; border: none; font-weight: bold; background: #444; color: white; }
        #download-link { display: none; background: #2ed573; color: white; text-decoration: none; padding: 12px 20px; border-radius: 25px; font-weight: bold; }
        video { display: none; }
    </style>
</head>
<body>

<div class="header">
    <div id="status-msg">STEP 1: 床をクリック</div>
    <div class="stats">
        <div>LIVE: <span id="current-h" class="value">0</span>cm</div>
        <div>BEST: <span id="max-h" class="value">0</span>cm</div>
    </div>
</div>

<canvas id="output_canvas"></canvas>
<video id="input_video" playsinline></video>

<div class="controls">
    <button onclick="resetCalibration()">設定リセット</button>
    <button onclick="resetMax()" style="background:#ff4757;">記録リセット</button>
    <a id="download-link">動画保存</a>
</div>

<script type="module">
    const videoElement = document.getElementById('input_video');
    const canvasElement = document.getElementById('output_canvas');
    const canvasCtx = canvasElement.getContext('2d');
    const statusMsg = document.getElementById('status-msg');
    const currentHDisplay = document.getElementById('current-h');
    const maxHDisplay = document.getElementById('max-h');
    const downloadLink = document.getElementById('download-link');

    let groundY = null, netY = null, pixelToCmRatio = 0, maxReach = 0;
    const NET_HEIGHT_CM = 243; 

    function speak(text) {
        const uttr = new SpeechSynthesisUtterance(text);
        uttr.lang = 'ja-JP';
        window.speechSynthesis.speak(uttr);
    }

    canvasElement.addEventListener('click', (e) => {
        const rect = canvasElement.getBoundingClientRect();
        const y = (e.clientY - rect.top) * (canvasElement.height / rect.height);
        if (groundY === null) { groundY = y; statusMsg.innerText = "STEP 2: ネットの上端をクリック"; }
        else if (netY === null) { netY = y; pixelToCmRatio = NET_HEIGHT_CM / Math.abs(groundY - netY); statusMsg.innerText = "READY!"; }
    });

    window.resetCalibration = () => { groundY = null; netY = null; pixelToCmRatio = 0; statusMsg.innerText = "STEP 1: 床をクリック"; };
    window.resetMax = () => { maxReach = 0; maxHDisplay.innerText = "0"; downloadLink.style.display = "none"; };

    function onResults(results) {
        canvasElement.width = results.image.width;
        canvasElement.height = results.image.height;
        canvasCtx.save();
        canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
        canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

        if (groundY !== null) { canvasCtx.strokeStyle = "red"; canvasCtx.strokeRect(0, groundY, canvasElement.width, 1); }
        if (netY !== null) { canvasCtx.strokeStyle = "#00ffcc"; canvasCtx.strokeRect(0, netY, canvasElement.width, 1); }

        if (results.poseLandmarks && pixelToCmRatio > 0) {
            const handY = Math.min(results.poseLandmarks[15].y, results.poseLandmarks[16].y) * canvasElement.height;
            const currentHeight = Math.round((groundY - handY) * pixelToCmRatio);
            
            if (currentHeight > 150) {
                currentHDisplay.innerText = currentHeight;
                if (currentHeight > maxReach) {
                    maxReach = currentHeight;
                    maxHDisplay.innerText = maxReach;
                    speak(maxReach + "センチ");
                }
            }
            drawConnectors(canvasCtx, results.poseLandmarks, POSE_CONNECTIONS, {color: '#00FF00', lineWidth: 2});
        }
        canvasCtx.restore();
    }

    const pose = new Pose({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`});
    pose.setOptions({ modelComplexity: 1, smoothLandmarks: true, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
    pose.onResults(onResults);

    // 背面カメラ設定
    const camera = new Camera(videoElement, {
        onFrame: async () => { await pose.send({image: videoElement}); },
        facingMode: 'environment', // これが背面カメラの指定
        width: 1280,
        height: 720
    });
    camera.start();
</script>
</body>
</html>
