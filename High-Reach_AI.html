<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>High-Reach AI Pro (Custom Height)</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils"></script>
    <style>
        body { margin: 0; background: #121212; color: white; font-family: sans-serif; overflow: hidden; display: flex; flex-direction: column; align-items: center; }
        .header { background: rgba(0,0,0,0.9); width: 100%; padding: 10px; text-align: center; border-bottom: 2px solid #00ffcc; position: fixed; top: 0; z-index: 100; }
        #status-msg { color: #ffcc00; font-size: 0.8rem; margin-bottom: 5px; }
        .setup-row { margin-bottom: 8px; font-size: 0.9rem; }
        input[type="number"] { width: 60px; padding: 5px; border-radius: 5px; border: none; text-align: center; font-weight: bold; }
        .stats { display: flex; justify-content: center; gap: 20px; }
        .value { color: #00ffcc; font-size: 1.5rem; font-weight: bold; }
        canvas { width: 100vw; height: 100vh; object-fit: contain; background: #000; }
        .controls { position: fixed; bottom: 20px; display: flex; gap: 10px; z-index: 100; }
        button { padding: 12px 18px; border-radius: 25px; border: none; font-weight: bold; background: #444; color: white; font-size: 0.8rem; }
        #download-link { display: none; background: #2ed573; color: white; text-decoration: none; padding: 12px 18px; border-radius: 25px; font-weight: bold; font-size: 0.8rem; }
        video { display: none; }
    </style>
</head>
<body>

<div class="header">
    <div id="status-msg">STEP 1: 床をクリック</div>
    <div class="setup-row">
        ネットの高さ: <input type="number" id="net-height-input" value="243"> cm
    </div>
    <div class="stats">
        <div>LIVE: <span id="current-h" class="value">0</span>cm</div>
        <div>BEST: <span id="max-h" class="value">0</span>cm</div>
    </div>
</div>

<canvas id="output_canvas"></canvas>
<video id="input_video" playsinline></video>

<div class="controls">
    <button onclick="resetCalibration()">設定リセット</button>
    <button onclick="resetMax()" style="background:#ff4757;">記録リセット</button>
    <a id="download-link">動画保存</a>
</div>

<script type="module">
    const videoElement = document.getElementById('input_video');
    const canvasElement = document.getElementById('output_canvas');
    const canvasCtx = canvasElement.getContext('2d');
    const statusMsg = document.getElementById('status-msg');
    const currentHDisplay = document.getElementById('current-h');
    const maxHDisplay = document.getElementById('max-h');
    const netHeightInput = document.getElementById('net-height-input');
    const downloadLink = document.getElementById('download-link');

    let groundY = null, netY = null, pixelToCmRatio = 0, maxReach = 0;

    function speak(text) {
        const uttr = new SpeechSynthesisUtterance(text);
        uttr.lang = 'ja-JP';
        window.speechSynthesis.speak(uttr);
    }

    canvasElement.addEventListener('click', (e) => {
        const rect = canvasElement.getBoundingClientRect();
        const y = (e.clientY - rect.top) * (canvasElement.height / rect.height);
        if (groundY === null) { 
            groundY = y; 
            statusMsg.innerText = "STEP 2: ネットの上端をクリック"; 
        }
        else if (netY === null) { 
            netY = y; 
            const netHeightCm = parseFloat(netHeightInput.value);
            pixelToCmRatio = netHeightCm / Math.abs(groundY - netY); 
            statusMsg.innerText = "READY!"; 
        }
    });

    window.resetCalibration = () => { groundY = null; netY = null; pixelToCmRatio = 0; statusMsg.innerText = "STEP 1: 床をクリック"; };
    window.resetMax = () => { maxReach = 0; maxHDisplay.innerText = "0"; downloadLink.style.display = "none"; };

    function onResults(results) {
        canvasElement.width = results.image.width;
        canvasElement.height = results.image.height;
        canvasCtx.save();
        canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
        canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

        if (groundY !== null) { 
            canvasCtx.strokeStyle = "red"; 
            canvasCtx.lineWidth = 3;
            canvasCtx.beginPath(); canvasCtx.moveTo(0, groundY); canvasCtx.lineTo(canvasElement.width, groundY); canvasCtx.stroke();
        }
        if (netY !== null) { 
            canvasCtx.strokeStyle = "#00ffcc"; 
            canvasCtx.lineWidth = 3;
            canvasCtx.beginPath(); canvasCtx.moveTo(0, netY); canvasCtx.lineTo(canvasElement.width, netY); canvasCtx.stroke();
        }

        if (results.poseLandmarks && pixelToCmRatio > 0) {
            const handY = Math.min(results.poseLandmarks[15].y, results.poseLandmarks[16].y) * canvasElement.height;
            const currentHeight = Math.round((groundY - handY) * pixelToCmRatio);
            
            if (currentHeight > 100) {
                currentHDisplay.innerText = currentHeight;
                if (currentHeight > maxReach) {
                    maxReach = currentHeight;
                    maxHDisplay.innerText = maxReach;
                    speak(maxReach + "センチ");
                }
            }
            drawConnectors(canvasCtx, results.poseLandmarks, POSE_CONNECTIONS, {color: '#00FF00', lineWidth: 2});
        }
        canvasCtx.restore();
    }

    const pose = new Pose({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`});
    pose.setOptions({ modelComplexity: 1, smoothLandmarks: true, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
    pose.onResults(onResults);

    const camera = new Camera(videoElement, {
        onFrame: async () => { await pose.send({image: videoElement}); },
        facingMode: 'environment',
        width: 1280,
        height: 720
    });
    camera.start();
</script>
</body>
</html>
